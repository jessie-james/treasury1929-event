<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mezzanine Seat Selection</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: auto;
      background-color: #fafafa;
    }
    
    .container {
      position: relative;
      width: 1000px;
      margin: 0 auto;
      overflow: auto;
    }
    
    .floor-plan {
      display: block;
      width: 1000px;
      height: auto;
    }
    
    .seat {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
      border: 2px solid transparent;
      box-sizing: border-box;
      background-color: rgba(34, 197, 94, 0.5);
    }
    
    .seat:hover {
      background-color: rgba(34, 197, 94, 0.7);
      transform: translate(-50%, -50%) scale(1.1);
    }
    
    .seat.selected {
      background-color: rgba(59, 130, 246, 0.8);
      border: 2px solid white;
    }
    
    .seat.unavailable {
      background-color: rgba(75, 85, 99, 0.8);
      cursor: not-allowed;
    }
    
    .seat.unavailable:hover {
      background-color: rgba(75, 85, 99, 0.9);
      transform: translate(-50%, -50%);
    }
    
    .tooltip {
      visibility: hidden;
      width: 120px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      text-align: center;
      padding: 5px;
      border-radius: 4px;
      position: absolute;
      z-index: 20;
      top: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      pointer-events: none;
    }
    
    .seat.unavailable:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="/mezzanine-floor.png" alt="Mezzanine Floor Plan" class="floor-plan" id="floorPlan">
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.querySelector('.container');
      
      // Get event ID from URL params
      const urlParams = new URLSearchParams(window.location.search);
      const eventId = urlParams.get('eventId') || 1; // Default to event 1 if not specified
      
      // Map to track seat availability
      const seatAvailability = {};
      
      // PERMANENT SEAT POSITIONS - These are the exact coordinates from the user
      const seatPositions = [
        {
          "tableId": 1,
          "seatNumber": 1,
          "left": 930,
          "top": 279
        },
        {
          "tableId": 1,
          "seatNumber": 2,
          "left": 946,
          "top": 304
        },
        {
          "tableId": 1,
          "seatNumber": 3,
          "left": 933,
          "top": 341
        },
        {
          "tableId": 1,
          "seatNumber": 4,
          "left": 904,
          "top": 351
        },
        {
          "tableId": 2,
          "seatNumber": 1,
          "left": 835,
          "top": 389
        },
        {
          "tableId": 2,
          "seatNumber": 2,
          "left": 796,
          "top": 397
        },
        {
          "tableId": 3,
          "seatNumber": 1,
          "left": 678,
          "top": 390
        },
        {
          "tableId": 3,
          "seatNumber": 2,
          "left": 641,
          "top": 398
        },
        {
          "tableId": 4,
          "seatNumber": 1,
          "left": 525,
          "top": 393
        },
        {
          "tableId": 4,
          "seatNumber": 2,
          "left": 485,
          "top": 394
        },
        {
          "tableId": 5,
          "seatNumber": 1,
          "left": 360,
          "top": 394
        },
        {
          "tableId": 5,
          "seatNumber": 2,
          "left": 321,
          "top": 394
        },
        {
          "tableId": 6,
          "seatNumber": 1,
          "left": 164,
          "top": 412
        },
        {
          "tableId": 6,
          "seatNumber": 2,
          "left": 136,
          "top": 384
        },
        {
          "tableId": 7,
          "seatNumber": 1,
          "left": 45,
          "top": 347
        },
        {
          "tableId": 7,
          "seatNumber": 2,
          "left": 31,
          "top": 309
        }
      ];

      let selectedSeats = [];
      let seatElements = [];
      
      // Function to fetch seat availability from API
      async function fetchSeatAvailability() {
        try {
          // Create a map to store all unique table IDs
          const tableIds = [...new Set(seatPositions.map(pos => pos.tableId))];
          
          // Fetch availability for each table
          for (const tableId of tableIds) {
            const response = await fetch(`/api/tables/${tableId}/seats?eventId=${eventId}`);
            if (!response.ok) {
              throw new Error(`Failed to fetch availability for table ${tableId}`);
            }
            const seats = await response.json();
            
            // Store availability information
            for (const seat of seats) {
              const key = `${tableId}-${seat.seatNumber}`;
              seatAvailability[key] = seat.isAvailable;
            }
          }
          
          // Now update the UI with availability
          updateSeatAvailability();
        } catch (error) {
          console.error('Error fetching seat availability:', error);
        }
      }
      
      // Function to update seat UI based on availability
      function updateSeatAvailability() {
        seatElements.forEach(element => {
          const tableId = parseInt(element.getAttribute('data-table'));
          const seatNumber = parseInt(element.getAttribute('data-seat'));
          const key = `${tableId}-${seatNumber}`;
          
          if (seatAvailability[key] === false) {
            // Mark as unavailable
            element.classList.add('unavailable');
            
            // Add tooltip to show this seat is unavailable
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = 'Seat unavailable';
            element.appendChild(tooltip);
            
            // Remove any click event listeners for unavailable seats
            const newElement = element.cloneNode(true);
            element.parentNode.replaceChild(newElement, element);
          }
        });
      }
      
      // Add seats to the container
      seatPositions.forEach(pos => {
        const seat = document.createElement('div');
        seat.className = 'seat';
        seat.setAttribute('data-table', pos.tableId);
        seat.setAttribute('data-seat', pos.seatNumber);
        seat.style.left = pos.left + 'px';
        seat.style.top = pos.top + 'px';
        
        // Add click event listener for all seats
        seat.addEventListener('click', function() {
          // Skip if seat is unavailable
          if (this.classList.contains('unavailable')) {
            return;
          }
          
          const tableId = parseInt(this.getAttribute('data-table'));
          const seatNumber = parseInt(this.getAttribute('data-seat'));
          const key = `${tableId}-${seatNumber}`;
          
          // Check if already selected
          const index = selectedSeats.findIndex(s => s.key === key);
          
          if (index >= 0) {
            // Remove if already selected
            selectedSeats.splice(index, 1);
            this.classList.remove('selected');
            this.textContent = '';
          } else {
            // Add if not selected (max 4)
            if (selectedSeats.length < 4) {
              selectedSeats.push({
                key,
                tableId,
                seatNumber
              });
              this.classList.add('selected');
              this.textContent = seatNumber;
            }
          }
          
          // Send message to parent window
          window.parent.postMessage({
            type: 'SEAT_SELECTION',
            selection: selectedSeats
          }, '*');
        });
        
        container.appendChild(seat);
        seatElements.push(seat);
      });
      
      // Listen for messages from parent window to get event ID
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'SET_EVENT_ID') {
          const newEventId = event.data.eventId;
          if (newEventId && newEventId !== eventId) {
            // Reset and refetch with new event ID
            selectedSeats = [];
            fetchSeatAvailability();
          }
        }
      });
      
      // Fetch availability data on page load
      fetchSeatAvailability();
    });
  </script>
</body>
</html>